<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor - Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/admin.css">
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar (same as dashboard) -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Admin Panel</h2>
                <p>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå</p>
            </div>
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item">
                    <span class="icon">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="monitor.html" class="nav-item active">
                    <span class="icon">üñ•Ô∏è</span>
                    <span>Monitor</span>
                </a>
                <a href="manage-pc.html" class="nav-item">
                    <span class="icon">üíª</span>
                    <span>Manage PC</span>
                </a>
                <a href="manage-software.html" class="nav-item">
                    <span class="icon">üì¶</span>
                    <span>Software</span>
                </a>
                <a href="import-reservation.html" class="nav-item">
                    <span class="icon">üì•</span>
                    <span>Import Reservation</span>
                </a>
                <a href="reports.html" class="nav-item">
                    <span class="icon">üìà</span>
                    <span>Reports</span>
                </a>
            </nav>
            <div style="padding: var(--spacing-xl); border-top: 1px solid var(--border);">
                <a href="../user/idle.html?pc=PC-001" style="color: var(--text-secondary); font-size: 0.875rem;">
                    ‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-header">
                <div>
                    <h1>Monitor PC Status</h1>
                    <div class="breadcrumb">
                        <a href="dashboard.html">Admin</a>
                        <span>/</span>
                        <span>Monitor</span>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="monitor-controls">
                <div class="view-toggle">
                    <button class="btn btn-primary" id="mapViewBtn">
                        üó∫Ô∏è Map View
                    </button>
                    <button class="btn btn-outline" id="tableViewBtn">
                        üìã Table View
                    </button>
                </div>
                <div>
                    <button class="btn btn-success" onclick="location.reload()">
                        üîÑ Refresh
                    </button>
                </div>
            </div>

            <!-- Map View -->
            <div id="mapView" class="pc-grid">
                <!-- PC cards will be loaded here -->
            </div>

            <!-- Table View -->
            <div id="tableView" class="table-container hidden">
                <table class="table">
                    <thead>
                        <tr>
                            <th>PC ID</th>
                            <th>Status</th>
                            <th>Location</th>
                            <th>User</th>
                            <th>Duration</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Rows will be loaded here -->
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- PC Detail Modal -->
    <div class="modal" id="pcModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">PC Details</h2>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal()">Close</button>
                <button class="btn btn-danger" id="forceLogoutBtn" style="display: none;">
                    Force Logout
                </button>
            </div>
        </div>
    </div>

    <script src="../js/config.js"></script>
    <script src="../js/utils.js"></script>
    <script>
        let currentView = 'map';

        // Toggle View
        document.getElementById('mapViewBtn').addEventListener('click', function() {
            currentView = 'map';
            document.getElementById('mapView').classList.remove('hidden');
            document.getElementById('tableView').classList.add('hidden');
            this.classList.add('btn-primary');
            this.classList.remove('btn-outline');
            document.getElementById('tableViewBtn').classList.remove('btn-primary');
            document.getElementById('tableViewBtn').classList.add('btn-outline');
        });

        document.getElementById('tableViewBtn').addEventListener('click', function() {
            currentView = 'table';
            document.getElementById('mapView').classList.add('hidden');
            document.getElementById('tableView').classList.remove('hidden');
            this.classList.add('btn-primary');
            this.classList.remove('btn-outline');
            document.getElementById('mapViewBtn').classList.remove('btn-primary');
            document.getElementById('mapViewBtn').classList.add('btn-outline');
        });

        // Load PCs - Map View
        function loadMapView() {
            const computers = getComputers();
            const container = document.getElementById('mapView');

            container.innerHTML = computers.map(pc => {
                const duration = pc.status === 'occupied' ? calculateDuration(pc.startTime) : 0;

                return `
                    <div class="pc-card ${pc.status}" onclick="showPCDetails('${pc.id}')">
                        <div class="pc-card-header">
                            <div class="pc-id">${pc.id}</div>
                            <div class="badge badge-${pc.status === 'available' ? 'success' : pc.status === 'occupied' ? 'danger' : 'gray'}">
                                <span class="status-dot ${pc.status}"></span>
                                ${pc.status === 'available' ? '‡∏ß‡πà‡∏≤‡∏á' : pc.status === 'occupied' ? '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡∏ã‡πà‡∏≠‡∏°'}
                            </div>
                        </div>
                        <div class="pc-card-body">
                            <div>üìç ${pc.location}</div>
                            ${pc.status === 'occupied' ? `
                                <div class="pc-user-info">
                                    <div>üë§ ${pc.currentUser}</div>
                                    <div class="pc-duration">‚è±Ô∏è ${duration} ‡∏ô‡∏≤‡∏ó‡∏µ</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Load PCs - Table View
        function loadTableView() {
            const computers = getComputers();
            const tbody = document.getElementById('tableBody');

            tbody.innerHTML = computers.map(pc => {
                const duration = pc.status === 'occupied' ? calculateDuration(pc.startTime) : '-';
                const user = pc.status === 'occupied' ? pc.currentUser : '-';

                return `
                    <tr>
                        <td><strong>${pc.id}</strong></td>
                        <td>
                            <span class="badge badge-${pc.status === 'available' ? 'success' : pc.status === 'occupied' ? 'danger' : 'gray'}">
                                ${pc.status === 'available' ? '‡∏ß‡πà‡∏≤‡∏á' : pc.status === 'occupied' ? '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡∏ã‡πà‡∏≠‡∏°'}
                            </span>
                        </td>
                        <td>${pc.location}</td>
                        <td>${user}</td>
                        <td>${duration}${typeof duration === 'number' ? ' ‡∏ô‡∏≤‡∏ó‡∏µ' : ''}</td>
                        <td class="table-actions">
                            <button class="btn btn-sm btn-primary" onclick="showPCDetails('${pc.id}')">
                                View
                            </button>
                            ${pc.status === 'occupied' ? `
                                <button class="btn btn-sm btn-danger" onclick="handleForceLogout('${pc.id}')">
                                    Force Logout
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Show PC Details Modal
        function showPCDetails(pcId) {
            const pc = getComputerById(pcId);
            const modal = document.getElementById('pcModal');
            const modalBody = document.getElementById('modalBody');
            const forceLogoutBtn = document.getElementById('forceLogoutBtn');

            document.getElementById('modalTitle').textContent = `${pc.id} Details`;

            let content = `
                <div class="form-group">
                    <label>PC ID</label>
                    <div>${pc.id}</div>
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <div>${pc.location}</div>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <div>
                        <span class="badge badge-${pc.status === 'available' ? 'success' : pc.status === 'occupied' ? 'danger' : 'gray'}">
                            ${pc.status === 'available' ? 'Available' : pc.status === 'occupied' ? 'Occupied' : 'Maintenance'}
                        </span>
                    </div>
                </div>
            `;

            if (pc.status === 'occupied') {
                const duration = calculateDuration(pc.startTime);
                content += `
                    <div class="form-group">
                        <label>Current User</label>
                        <div>${pc.currentUser}</div>
                    </div>
                    <div class="form-group">
                        <label>Start Time</label>
                        <div>${formatTime(pc.startTime)}</div>
                    </div>
                    <div class="form-group">
                        <label>Duration</label>
                        <div>${duration} ‡∏ô‡∏≤‡∏ó‡∏µ</div>
                    </div>
                `;
                forceLogoutBtn.style.display = 'block';
                forceLogoutBtn.onclick = () => handleForceLogout(pcId);
            } else {
                forceLogoutBtn.style.display = 'none';
            }

            modalBody.innerHTML = content;
            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('pcModal').classList.remove('active');
        }

        // Force Logout
        function handleForceLogout(pcId) {
            if (confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Force Logout ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ${pcId} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö...');
                setTimeout(() => {
                    forceLogout(pcId);
                    hideLoading();
                    showAlert('Force logout ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    closeModal();
                    loadMapView();
                    loadTableView();
                }, 1000);
            }
        }

        // Initialize
        loadMapView();
        loadTableView();

        // Auto refresh every 10 seconds
        setInterval(() => {
            loadMapView();
            loadTableView();
        }, 10000);

        // Close modal on outside click
        document.getElementById('pcModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>
</body>
</html>
