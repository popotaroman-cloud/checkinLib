<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>กำลังใช้งาน - ระบบเช็คอินคอมพิวเตอร์</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/user.css">
</head>
<body>
    <div class="user-container">
        <div class="user-card fade-in">
            <div class="user-header">
                <div class="pc-badge" id="pcBadge">PC-001</div>
                <h1>กำลังใช้งาน</h1>
            </div>

            <div class="session-container">
                <!-- Timer -->
                <div class="timer-display" id="timer">00:00:00</div>

                <!-- User Info -->
                <div class="session-info">
                    <h3 id="userName">ชื่อผู้ใช้</h3>
                    <p id="userFaculty">คณะ/หน่วยงาน</p>
                    <p class="session-duration" id="sessionStart"></p>
                </div>

                <!-- Instructions -->
                <div style="margin: 2rem 0;">
                    <p style="color: var(--text-secondary);">
                        เมื่อใช้งานเสร็จแล้ว กรุณากดปุ่มด้านล่างเพื่อเช็คเอาท์
                    </p>
                </div>

                <!-- Checkout Button -->
                <button class="btn btn-danger btn-lg btn-block" id="checkoutBtn">
                    เลิกใช้งาน (Check-out)
                </button>
            </div>
        </div>
    </div>

    <script src="../js/config.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/session-manager.js"></script>
    <script>
        // Get parameters
        const params = getURLParams();
        const pcId = params.pc || 'PC-001';
        const userId = params.user;

        document.getElementById('pcBadge').textContent = pcId;

        // ตรวจสอบ Session
        if (!SessionManager.hasActiveSession()) {
            alert('ไม่พบ Session การใช้งาน');
            navigateTo('idle.html', { pc: pcId });
        } else {
            const sessionInfo = SessionManager.getSessionInfo();

            // ตรวจสอบว่าตรงกับ URL หรือไม่
            if (sessionInfo.pcId !== pcId || sessionInfo.userId !== userId) {
                alert('Session ไม่ถูกต้อง');
                navigateTo('idle.html', { pc: pcId });
            } else {
                // แสดงข้อมูลผู้ใช้
                document.getElementById('userName').textContent = sessionInfo.userName;
                document.getElementById('userFaculty').textContent = sessionInfo.faculty;
                document.getElementById('sessionStart').textContent = 'เริ่มใช้งาน: ' + formatTime(sessionInfo.startTime);

                // เริ่มจับเวลาด้วย SessionManager
                SessionManager.startTimer((info) => {
                    // อัพเดท Timer
                    document.getElementById('timer').textContent = info.elapsed.formatted;

                    // เปลี่ยนสีถ้าใกล้หมดเวลา
                    if (info.isNearLimit) {
                        document.getElementById('timer').style.color = '#ef4444';
                    }
                });

                // ป้องกันการปิดหน้าต่างโดยไม่ตั้งใจ
                SessionManager.enableUnloadProtection();

                // Checkout button
                document.getElementById('checkoutBtn').addEventListener('click', function() {
                    const confirmed = confirm('ต้องการเลิกใช้งานหรือไม่?');

                    if (confirmed) {
                        const duration = SessionManager.getElapsedMinutes();

                        // Navigate to feedback page
                        navigateTo('feedback.html', {
                            pc: pcId,
                            user: userId,
                            duration: duration
                        });
                    }
                });
            }
        }
    </script>
</body>
</html>
